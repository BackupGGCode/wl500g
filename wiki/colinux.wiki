#Сборка прошивки под windows

= Сборка прошивки под windows =

== Введение ==

Для того чтобы иметь возможность собирать пакеты и прошивку не перезагружаясь в linux необходимо установить colinux. 
coLinux — это порт ядра Linux, работающий как служба Microsoft Windows. Что на порядок быстрее чем запуск отдельной виртуальной машины такой как vmware, boch или Qemu (где используется полная эмуляция процессора).

== Установка Cooperative Linux ==

Для начала потребуется скачать последнюю стабильную версию colinux 
http://sourceforge.net/projects/colinux/files
можно попробовать воспользоваться девелоперской версией
http://colinux.org/snapshots/
Во время установки coLinux нужно будет убрать галку *Root Filesystem image (Download)*, так как нужный образ мы скачаем позже.
colinux необходимо установить в c:\colinux
Далее потребуется образ дистрибутива Linux Slackware 12.2
Его можно взять по одному из рабочих "зеркал" (http://slackware.com/getslack/), необходимо скачать dvd образ и поместить его в директорию c:\colinux\linux\ задав имя файла *slack12.iso*
Т.к. я пользуюсь Slackware то далее будет рассказано о установке именно этого дистрибутива.

Далее необходимо создать пустые файлы для подключения их в качестве дисков.
{{{
c:\>fsutil.exe file createnew c:\colinux\linux\root_fs.img 3000000000
c:\>fsutil.exe file createnew c:\colinux\linux\hdb.img 3000000000
c:\>fsutil.exe file createnew c:\colinux\linux\hdc.img 2000000000
c:\>fsutil.exe file createnew c:\colinux\linux\swap.img 300000000
}}}

теперь нужно создать файл с опциями запуска colinux
*install.conf*
{{{
kernel=vmlinux
hda=c:\coLinux\linux\root_fs.img
hdd=c:\coLinux\linux\slack12.iso
root=/dev/ram load_ramdisk=1 prompt_ramdisk=0 ramdisk_size=10000
initrd=initrd.img
mem=256
cocon=120x40
}}}

Для инсталляции Slackware, во время первого запуска colinux потребуется файл initrd.img, он находится на скаченном диске дистрибутива. Чтобы его от туда извлечь можно подключить dvd образ, например через программу alcohol, я воспользовался плагином к Total Commander 

После того как все подготовлено необходимо запустить установку linux  
{{{
c:\> cd c:\colinux
c:\> colinux-daemon.exe -t nt @install.conf
}}}

появится предложение выбрать раскладку клавиатуры и ввести имя пользователя, можно нажать 2 раза enter.
далее подключаем диск с дистрибутивом linux 
{{{
mount /dev/hdd /cdrom
}}}
форматируем раздел hda
{{{
mkfs.ext2 -j /dev/hda
}}}
на вопрос *Proceed anyway? (y,n)* необходимо ответить *y*

подключаем раздел
{{{
mount /dev/hda /mnt
}}}

создаем swap
{{{
mkswap /dev/hde
}}}

далее необходимо установить нужные пакеты 
{{{
cd /cdrom/slackware/a
installpkg -root /mnt *.tgz
cd /cdrom/slackware/ap
installpkg -root /mnt *.tgz
cd /cdrom/slackware/d
installpkg -root /mnt *.tgz
cd /cdrom/slackware/f
installpkg -root /mnt *.tgz
cd /cdrom/slackware/l
installpkg -root /mnt *.tgz
cd /cdrom/slackware/n
installpkg -root /mnt *.tgz
}}}
после установки выключаем виртуальную машину.
{{{
poweroff
}}}

теперь нужно создать файл с опциями стандартного запуска colinux 

*slack.conf*
{{{
kernel=vmlinux
hda=c:\coLinux\linux\root_fs.img
hdb=c:\coLinux\linux\hdb.img
hdc=c:\coLinux\linux\hdc.img
hdd=c:\coLinux\linux\slack12.iso
hde=c:\coLinux\linux\swap.img
root=/dev/hda ro
initrd=initrd.gz
mem=128
cocon=120x40
eth0=tuntap
}}}

далее запускаем установленную Slackware 

{{{
c:\> cd c:\colinux
c:\> colinux-daemon.exe --install-service colinux @slack.conf
}}}

== Настройка системы ==

После того как все нужные пакеты установлены необходимо подготовить рабочее окружение.
Необходимо настроить автомонтирование дисков в файле

*/etc/fstab*
{{{
/dev/hda        /               ext2      noatime         2     2
/dev/hdb        /home           ext3      noatime         2     2
/dev/hdc        /wl500g         ext3      noatime         2     2
/dev/hdd        /dvd            iso9660   defaults        0     0
/dev/hde        swap            swap      defaults        0     0
proc            /proc           proc      defaults        0     0
devpts          /dev/pts        devpts    gid=5,mode=620  0     0
}}}

После этого необходимо добавить в профиль переменные среды и необходимые для сборки прошивки пути.
Поместите в конец файла */etc/profile* следующие переменные строки.
{{{
export OPTWARE_TARGET="oleg"
export LANG="ru_RU.UTF-8"
export PATH=$PATH:/opt/brcm/hndtools-mipsel-uclibc/bin
}}}

Теперь необходимо убрать автозапуск лишних сервисов, выполнив команды
{{{
cd /etc/rc.d
chmod -x rc.bluetooth.conf rc.httpd rc.local rc.nfsd rc.sendmail rc.udev rc.acpid 
chmod -x rc.cups rc.messagebus rc.ntpd rc.serial rc.wireless rc.alsa rc.dnsmasq rc.pcmcia
chmod -x rc.snmpd rc.wireless.conf rc.atalk rc.modules-2.6.27.7 rc.rpc rc.sshd rc.yp 
chmod -x rc.bind rc.fuse rc.inetd rc.modules-2.6.27.7-smp rc.samba rc.syslog rc.bluetooth 
chmod -x rc.hald rc.ip_forward rc.mysqld rc.saslauthd rc.sysvinit
}}}

в файле */etc/rc.d/rc.inet1.conf* необходимо настроить IP адрес, маску и шлюз по умолчанию.
{{{
IPADDR[0]="192.168.0.2"
NETMASK[0]="255.255.255.0"
GATEWAY="192.168.0.1"
}}}

Далее перезагрузка системы.

{{{
reboot
}}}

Если все нормально загрузка прошла штатно, то можно добавить виртуальную машину colinux в список служб windows командой:
{{{
c:\> colinux-daemon.exe --install-service "colinux" @slack.conf
}}}

После этого можно запускать или останавливать службу coLinux через панель управления служб, или из командной строки.

{{{
net start colinux
net stop colinux
}}}

== Компиляция ==

*install.sh*
{{{
#!/bin/sh
inst=`pwd -P`
mkdir $inst/broadcom/src/linux -p
mkdir /opt/brcm -p
tar -C $inst -zxvf GPL_1927.zip
tar -C $inst/broadcom/src -jxvf wl500g-1.9.2.7-d.tar.bz2
tar -C /opt/brcm -jxvf hndtools-mipsel-uclibc-4.1.2-1.tar.bz2
ln -sf /opt/brcm/hndtools-mipsel-uclibc-4.1.2 /opt/brcm/hndtools-mipsel-uclibc
rm -rf $inst/broadcom/src/linux/linux
tar -C $inst/broadcom/src/linux -jxvf linux-2.4.37.tar.bz2
ln -sf linux-2.4.37 $inst/broadcom/src/linux/linux
}}}


*ссылки:*

  * http://www.ibm.com/developerworks/ru/library/l-virtualization-colinux/
  * http://flora.org.ru/2007/07/03/colinux-veshh-v-vende-zamechaniya-i-pervichnaya-nastrojka/
  * http://str.lug.ru/articles/colinux.shtml